<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tela.js Tests</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }

        details {
            width: 100%;
            font-size: 1.5rem;
        }

        iframe {
            margin: auto;
            width: 100%;
            height: 31rem;
        }
    </style>
</head>

<body>

</body>
<script type="module">
    import DOM from "../src/DomBuilder.js";
    const range = (n, i = 0) => n === 0 ? [] : [i].concat(range(n - 1, i + 1));
    function toggleFullScreen(elem) {
        if (!document.fullscreenElement &&    // alternative standard method
            !document.mozFullScreenElement &&
            !document.webkitFullscreenElement &&
            !document.msFullscreenElement) {  // current working methods
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
            }
        }
    }
    async function createIframeSrcWith(path) {
        return await fetch(path)
            .then(f => f.text())
            .then(canvasFunction => {
                const iframe = DOM.of("iframe");
                iframe
                    .event("load", () => {
                        const mainBody = `
                        <div>
                            <canvas width="640" height="480"></canvas>
                            <p id="logger"></p>
                        </div>
                        `;
                        iframe.element.contentDocument.body.innerHTML = mainBody;
                        // seems like the only way to run a script inside iframe
                        const script = DOM.of("script").build();
                        script.type = "module";
                        script.textContent = `
                        import {Canvas, DOM, Color, Animator} from "/dist/web/index.js"
                        ${toggleFullScreen.toString()}
                        const canvasDOM = document.getElementsByTagName("canvas")[0];
                        const canvas = Canvas.ofDOM(canvasDOM);
                        canvasDOM.addEventListener('click', () => {
                            toggleFullScreen(canvasDOM);
                        });
                        (${canvasFunction})(canvas, {print: (message) => {document.getElementById("logger").innerText = message}, log: () => {document.getElementById("logger").innerText += message}})
                        `;
                        iframe.element.contentDocument.body.appendChild(script);
                        iframe.element.contentWindow.addEventListener("error", (e) => {
                            iframe.element.contentDocument.body.innerHTML = `
                            <style>body { background-color: rgba(0,0,0,0.89); color: white}</style>
                            <p style="color: red">${e.message} at line ${e.lineno}</p>
                            `;
                        })
                    })
                return iframe;
            })
    }

    (async () => {
        const iframes = await Promise.all(
            range(5)
                .map(async i => {
                    const container = DOM.of("div");
                    const details = DOM.of("details")
                        .appendChild(
                            DOM.of("summary")
                                .inner(`Test ${i}`),
                            container
                        )
                    const iframe = await createIframeSrcWith(`/test/test${i}.js`);
                    details.event("toggle", ({ target: detailElem }) => {
                        if (detailElem.open) {
                            container.appendChild(iframe);
                        }
                    })
                    return details;
                })
        )
        iframes.map(x => {
            document.body.appendChild(x.build());
        })
    })()
</script>

</html>