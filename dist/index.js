!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Tela=e():t.Tela=e()}(self,(()=>(()=>{"use strict";var t={d:(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{Animator:()=>rt,BBox:()=>X,Canvas:()=>$,Canvas2D_old:()=>w,Canvas2d:()=>st,Canvas_old:()=>y,Color:()=>O,ImageIO:()=>i,Matrix:()=>V,Utils:()=>n});var n={};t.r(n),t.d(n,{perf:()=>tt,testBuilder:()=>et});var r={getImageCanvas:function(t){var e=document.createElement("canvas");e.width=t.width,e.height=t.height;var n=e.getContext("2d");return n.fillStyle="rgba(0, 0, 0, 0)",n.globalCompositeOperation="source-over",n.fillRect(0,0,e.width,e.height),n.drawImage(t,0,0),e},getDataFromImage:function(t){return canvas=r.getImageCanvas(t),canvas.getContext("2d").getImageData(0,0,t.width,t.height)},loadImage:function(t){var e=new Image;return e.src=t,e.isReady=!1,e.onload=function(){return e.isReady=!0},e},generateImageReadyPredicate:function(t){return function(){return t.isReady}}};const i=r;function a(t,e){var n=[];return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n}function o(t){var e=[];return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function u(t,e){var n=[];return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n}function s(t,e){return t[0]*e[0]+t[1]*e[1]}function h(t){return s(t,t)}function c(t){return Math.sqrt(s(t,t))}function l(t,e){var n=[];return n[0]=Math.min(t[0],e[0]),n[1]=Math.min(t[1],e[1]),n}function f(t,e){var n=[];return n[0]=Math.max(t[0],e[0]),n[1]=Math.max(t[1],e[1]),n}function v(t,e,n){var r=n[1]/t[1];return[r,(-t[0]*r+n[0])/e]}function d(t,e,n){var r=n[0]/t[0];return[r,(-t[1]*r+n[1])/e]}var p,g=function(t){this.canvas=t,this.ctx=t.getContext("2d"),this.image=this.ctx.getImageData(0,0,t.width,t.height),this.imageData=this.image.data};g.prototype.getSize=function(){return[this.canvas.height,this.canvas.width]},g.prototype.paintImage=function(){this.ctx.putImageData(this.image,0,0)},g.prototype.getCanvas=function(){return this.canvas},g.prototype.clearImage=function(t){this.useCanvasCtx((function(e){var n=e.getSize();e.ctx.fillStyle="rgba("+t[0]+","+t[1]+","+t[2]+","+t[3]+")",e.ctx.globalCompositeOperation="source-over",e.ctx.fillRect(0,0,n[1],n[0])}),!0)},g.prototype.useCanvasCtx=function(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1]||this.ctx.putImageData(this.image,0,0),t(this),this.image=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),this.imageData=this.image.data},g.prototype.getImageIndex=function(t){return 4*(this.canvas.width*t[0]+t[1])},g.prototype.getPxl=function(t){var e=this.getImageIndex(t);return[this.imageData[e],this.imageData[e+1],this.imageData[e+2],this.imageData[e+3]]},g.prototype.drawPxl=function(t,e){var n=this.getImageIndex(t);this.imageData[n]=e[0],this.imageData[n+1]=e[1],this.imageData[n+2]=e[2],this.imageData[n+3]=e[3]},g.prototype.drawLine=function(t,e,n){n.points=[t,e];var r=[];r.push(t),r.push(e);for(var i=[],a=[],o=0;o<r.length;o++)0<=(f=r[o])[0]&&f[0]<this.canvas.height&&0<=f[1]&&f[1]<this.canvas.width?i.push(f):a.push(f);if(2!=i.length){var h=[],c=[e[0]-t[0],e[1]-t[1]];h.push(v(c,-(this.canvas.height-1),[-t[0],-t[1]])),h.push(d(c,-(this.canvas.width-1),[this.canvas.height-1-t[0],-t[1]])),h.push(v(c,this.canvas.height-1,[this.canvas.height-1-t[0],this.canvas.width-1-t[1]])),h.push(d(c,this.canvas.width-1,[-t[0],this.canvas.width-1-t[1]]));var l=[];for(o=0;o<h.length;o++){var f;0<=(f=h[o])[0]&&f[0]<=1&&0<=f[1]&&f[1]<=1&&l.push(f)}if(0!=l.length)if(i.length>0){var p=[t[0]+l[0][0]*c[0],t[1]+l[0][0]*c[1]];this.drawLineInt(i.pop(),p,n)}else{var g=[t[0]+l[0][0]*c[0],t[1]+l[0][0]*c[1]];for(o=1;o<l.length;o++)if(s(c=u(p=[t[0]+l[o][0]*c[0],t[1]+l[o][0]*c[1]],g),c)>.001)return void this.drawLineInt(g,p,n);this.drawLineInt(g,g,n)}}else this.drawLineInt(i[0],i[1],n)},g.prototype.drawLineInt=function(t,e,n){t=o(t),e=o(e);var r=[-1,0,1],i=r.length,h=i*i,c=[];c[0]=t[0],c[1]=t[1];var l=u(e,t),f=[];for(f[0]=-l[1],f[1]=l[0],n(c,n.points,this);c[0]!==e[0]||c[1]!==e[1];){for(var v=Number.MAX_VALUE,d=[],p=0;p<h;p++){var g=r[p%i],y=r[Math.floor(p/i)],m=u(a(c,[g,y]),t),w=Math.abs(s(m,f))-s(m,l);v>w&&(v=w,d=[g,y])}n(c=a(c,d),n.points,this)}n(c,n.points,this)},g.prototype.drawPolygon=function(t,e){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:g.isInsidePolygon,r=[[Number.MAX_VALUE,Number.MAX_VALUE],[Number.MIN_VALUE,Number.MIN_VALUE]],i=0;i<t.length;i++)r[0]=l(t[i],r[0]),r[1]=f(t[i],r[1]);var a=u(this.getSize(),[1,1]),s=[0,0];r[0]=o(l(a,f(s,r[0]))),r[1]=o(l(a,f(s,r[1])));for(var h=r[0][0];h<r[1][0];h++)for(var c=r[0][1];c<r[1][1];c++){var v=[h,c];n(v,t)&&e(v,t,this)}},g.prototype.drawTriangle=function(t,e,n,r){var i=[t,e,n];this.drawPolygon(i,r,g.isInsideConvex)},g.prototype.drawQuad=function(t,e,n,r,i){this.drawPolygon([t,e,n,r],i)},g.prototype.drawImage=function(t,e){"isReady"in t&&!t.isReady||this.useCanvasCtx((function(n){return n.ctx.drawImage(t,e[1],e[0])}))},g.prototype.drawCircle=function(t,e,n){var r=function(t,e){var n=[];return n[0]=t[0]*e,n[1]=t[1]*e,n}([1,1],e),i=[u(t,r),a(t,r)],s=this.getSize();i[0]=o(l(u(s,[1,1]),f([0,0],i[0]))),i[1]=o(l(u(s,[1,1]),f([0,0],i[1])));for(var h=i[0][0];h<=i[1][0];h++)for(var c=i[0][1];c<=i[1][1];c++){var v=[h,c];this.isInsideCircle(v,t,e)&&n(v,[t,e],this)}},g.prototype.isInsideCircle=function(t,e,n){return h(u(t,e))<=n*n},g.prototype.addEventListener=function(t,e,n){this.canvas.addEventListener(t,e,n)},g.prototype.drawString=function(t,e,n){this.useCanvasCtx((function(r){n(r.ctx),r.ctx.fillText(e,t[1],t[0])}))},g.isInsidePolygon=function(t,e){for(var n=[],r=0,i=e.length,a=0;a<i;a++)n[0]=u(e[(a+1)%i],t),n[1]=u(e[a],t),r+=Math.acos(s(n[0],n[1])/(c(n[0])*c(n[1])));return Math.abs(r-2*Math.PI)<.001},g.isInsideConvex=function(t,e){for(var n=e.length,r=[],i=[],a=0;a<n;a++){r[a]=u(e[(a+1)%n],e[a]);var o=[-r[a][1],r[a][0]],h=u(t,e[a]);i[a]=s(h,o)}var c=r[0][0]*r[1][1]-r[0][1]*r[1][0]>0?1:-1;for(a=0;a<n;a++)if(i[a]*c<0)return!1;return!0},g.simpleShader=function(t){return function(e,n,r){return r.drawPxl(e,t)}},g.colorShader=function(t){return g.interpolateTriangleShader((function(e,n,r,i){for(var a=[0,0,0,0],o=0;o<n.length;o++)a[0]=a[0]+t[o][0]*i[o],a[1]=a[1]+t[o][1]*i[o],a[2]=a[2]+t[o][2]*i[o],a[3]=a[3]+t[o][3]*i[o];r.drawPxl(e,a)}))},g.interpolateQuadShader=function(t){return function(e,n,r){var i=[n[0],n[1],n[2]],a=[n[2],n[3],n[0]],o=g.triangleBaryCoord(e,i);o[0]>0&&o[1]>0&&o[2]>0&&Math.abs(o[0]+o[1]+o[2]-1)<1e-10?t(e,n,r,[o[0],o[1],o[2],0]):(o=g.triangleBaryCoord(e,a),t(e,n,r,[o[2],0,o[0],o[1]]))}},g.interpolateTriangleShader=function(t){return function(e,n,r){var i=g.triangleBaryCoord(e,n);t(e,n,r,i)}},g.interpolateLineShader=function(t){return function(e,n,r){var i=u(n[1],n[0]),a=u(e,n[0]),o=h(i),c=s(a,i);t(e,n,r,0==o?0:c/o)}},g.quadTextureShader=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:g.bilinearInterpolation,r=null;return g.interpolateQuadShader((function(s,h,c,v){t.isReady&&null!=r||(r=new g(i.getImageCanvas(t)));for(var d=r,p=d.getSize(),y=[0,0],m=0;m<e.length;m++)y[0]=y[0]+e[m][0]*v[m],y[1]=y[1]+e[m][1]*v[m];var w=[(1-y[1])*(p[1]-1),(p[0]-1)*y[0]],b=o(w=f([0,0],l(u([p[0],p[1]],[1,1]),w))),x=[d.getPxl(b),d.getPxl(a(b,[1,0])),d.getPxl(a(b,[1,1])),d.getPxl(a(b,[0,1]))],k=n(x,u(w,b));c.drawPxl(s,k)}))},g.triangleCache=(p=[],{constains:function(t){return null!=p[t%3]},get:function(t){return p[t%3]},set:function(t,e){return p[t%3]=e}}),g.triangleHash=function(t){return[t[0][0],t[1][0],t[2][0],t[0][1],t[1][1],t[2][1]].reduce((function(t,e){return 31*t+e}),1)},g.triangleBaryCoord=function(t,e){var n=g.triangleHash(e),r=[t[0]-e[0][0],t[1]-e[0][1]];if(!g.triangleCache.constains(n)){var i=[e[1][0]-e[0][0],e[1][1]-e[0][1]],a=[e[2][0]-e[0][0],e[2][1]-e[0][1]],o=i[0]*a[1]-i[1]*a[0];g.triangleCache.set(n,{triangle:e,u:i.map((function(t){return t/o})),v:a.map((function(t){return t/o})),det:o,hash:n})}var u=g.triangleCache.get(n),s=u.u,h=u.v;if(0==u.det)return[0,0,0];var c=[h[1]*r[0]-h[0]*r[1],s[0]*r[1]-s[1]*r[0]];return[1-c[0]-c[1],c[0],c[1]]},g.bilinearInterpolation=function(t,e){for(var n=[],r=0;r<t.length;r++){var i=t[0][r]+(t[3][r]-t[0][r])*e[1],a=i+(t[1][r]+(t[2][r]-t[1][r])*e[1]-i)*e[0];n.push(a)}return n},g.createCanvas=function(t,e){var n=document.createElement("canvas");return n.setAttribute("width",t[0]),n.setAttribute("height",t[1]),document.getElementById(e).appendChild(n),n};const y=g;var m=function(t,e){if(y.call(this,t),2!=e.length||2!=e[0].length&&2!=e[1].length)throw"camera space must be 2-dim array with 2-dim arrays representing an interval";this.cameraSpace=e};(m.prototype=Object.create(y.prototype)).constructor=m,m.prototype.integerTransform=function(t){return[-(this.canvas.height-1)/(this.cameraSpace[1][1]-this.cameraSpace[1][0])*(t[1]-this.cameraSpace[1][1]),(this.canvas.width-1)/(this.cameraSpace[0][1]-this.cameraSpace[0][0])*(t[0]-this.cameraSpace[0][0])]},m.prototype.inverseTransform=function(t){return[this.cameraSpace[0][0]+(this.cameraSpace[0][1]-this.cameraSpace[0][0])/(this.canvas.width-1)*t[1],this.cameraSpace[1][1]-(this.cameraSpace[1][1]-this.cameraSpace[1][0])/(this.canvas.height-1)*t[0]]},m.prototype.drawLine=function(t,e,n){var r=this.integerTransform(t),i=this.integerTransform(e);y.prototype.drawLine.call(this,r,i,n)},m.prototype.drawTriangle=function(t,e,n,r){var i=this.integerTransform(t),a=this.integerTransform(e),o=this.integerTransform(n);y.prototype.drawTriangle.call(this,i,a,o,r)},m.prototype.drawQuad=function(t,e,n,r,i){var a=this.integerTransform(t),o=this.integerTransform(e),u=this.integerTransform(n),s=this.integerTransform(r);y.prototype.drawQuad.call(this,a,o,u,s,i)},m.prototype.drawCircle=function(t,e,n){var r=this.integerTransform(t),i=this.integerTransform([e,0])[1]-this.integerTransform([0,0])[1];y.prototype.drawCircle.call(this,r,i,n)},m.prototype.drawImage=function(t,e){y.prototype.drawImage.call(this,t,this.integerTransform(e))},m.prototype.drawString=function(t,e,n){var r=this.integerTransform(t);y.prototype.drawString.call(this,r,e,n)},m.prototype.setCamera=function(t){if(2!=t.length||2!=t[0].length&&2!=t[1].length)throw"camera space must be 2-dim array with 2-dim arrays representing an interval";this.cameraSpace=t};const w=m;function b(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function x(t,e){if(t){if("string"==typeof t)return b(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?b(t,e):void 0}}function k(t){return function(t){if(Array.isArray(t))return b(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||x(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function C(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,i,a,o,u=[],s=!0,h=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;s=!1}else for(;!(s=(r=a.call(n)).done)&&(u.push(r.value),u.length!==e);s=!0);}catch(t){h=!0,i=t}finally{try{if(!s&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(h)throw i}}return u}}(t,e)||x(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function R(t){return R="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},R(t)}function I(t){var e=function(t,e){if("object"!==R(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!==R(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===R(e)?e:String(e)}function A(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,I(r.key),r)}}function S(t,e,n){return e&&A(t.prototype,e),n&&A(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function E(t,e,n){return(e=I(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var T,P,M=255,O=function(){function t(e){_(this,t),this.rgba=e}return S(t,[{key:"getRGBA",value:function(){return this.rgba}},{key:"red",get:function(){return this.rgba[0]}},{key:"green",get:function(){return this.rgba[1]}},{key:"blue",get:function(){return this.rgba[2]}},{key:"alpha",get:function(){return this.rgba[3]}},{key:"redRaw",get:function(){return this.red*M}},{key:"greenRaw",get:function(){return this.green*M}},{key:"blueRaw",get:function(){return this.blue*M}},{key:"equals",value:function(t){for(var e=0;e<this.rgba.length;e++)if(this.rgba[e]!==t.rgba[e])return!1;return!0}}],[{key:"ofRGBA",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=new Uint8Array(4);return a[0]=e*M,a[1]=n*M,a[2]=r*M,a[3]=i*M,new t(a)}},{key:"ofRGBARaw",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:255,a=new Uint8Array(4);return a[0]=e,a[1]=n,a[2]=r,a[3]=i,new t(a)}},{key:"random",value:function(){var e=function(){return 256*Math.random()};return t.ofRGBA(e(),e(),e(),e())}}]),t}();function B(t,e){return B=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},B(t,e)}function j(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&B(t,e)}function L(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function D(t,e){if(e&&("object"===R(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return L(t)}function z(t){return z=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},z(t)}function G(t,e,n){return G=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}()?Reflect.construct.bind():function(t,e,n){var r=[null];r.push.apply(r,e);var i=new(Function.bind.apply(t,r));return n&&B(i,n.prototype),i},G.apply(null,arguments)}function F(t){var e="function"==typeof Map?new Map:void 0;return F=function(t){if(null===t||!function(t){try{return-1!==Function.toString.call(t).indexOf("[native code]")}catch(e){return"function"==typeof t}}(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return G(t,arguments,z(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),B(n,t)},F(t)}E(O,"RED",(T=O).ofRGBA(1,0,0)),E(O,"GREEN",T.ofRGBA(0,1,0)),E(O,"BLUE",T.ofRGBA(0,0,1)),E(O,"BLACK",T.ofRGBA(0,0,0)),E(O,"WHITE",T.ofRGBA(1,1,1));var q=function(t,e){return function(t,n){return n+t*e}},U=function(t,e){return function(t){return[t/e,t%e].map(Math.floor)}},N=function(){function t(){_(this,t),this._size=[],this.data={}}return S(t,[{key:"size",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this._size=[t,e],this}},{key:"set",value:function(t,e,n){if(0===this._size.length)throw new H("Setting value to empty matrix");return this.data[function(t,e){return"".concat(t,",").concat(e)}(t,e)]=n,this}},{key:"build",value:function(){var t=this,e=C(this._size,2),n=e[0],r=e[1],i=new Float64Array(n*r),a=q(0,r);return Object.keys(this.data).forEach((function(e){var n;i[a.apply(void 0,k((n=e,n.split(",").map(Number))))]=t.data[e]})),new V(i,this._size)}}]),t}(),Z=function(){function t(){_(this,t),this.rows=[],this.dim=0}return S(t,[{key:"addRow",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(0===this.dim&&(this.dim=e.length),this.dim!==e.length)throw new H("Added row of different dimension, actual dim is ".concat(this.dim));return this.rows.push(e),this}},{key:"build",value:function(){if(this.rows.length>0)return this._buildWithRows();throw new H("Building empty matrix")}},{key:"_buildWithRows",value:function(){for(var t=this.rows.length,e=this.dim,n=new Float64Array(t*e),r=q(0,e),i=0;i<t;i++)for(var a=0;a<e;a++)n[r(i,a)]=this.rows[i][a];return new V(n,[t,e])}}]),t}(),Y=new WeakSet,W=function(){function t(){var e,n;_(this,t),function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}(e=this,n=Y),n.add(e),this.cols=[],this.dim=0}return S(t,[{key:"addCol",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(0===this.dim&&(this.dim=e.length),this.dim!==e.length)throw new H("Added col of different dimension, actual dim is ".concat(this.dim));return this.cols.push(e),this}},{key:"build",value:function(){if(this.cols.length>0)return function(t,e,n){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return n}(this,Y,Q).call(this);throw new H("Building empty matrix")}}]),t}();function Q(){for(var t=this.dim,e=this.cols.length,n=new Float64Array(t*e),r=q(0,e),i=0;i<t;i++)for(var a=0;a<e;a++)n[r(i,a)]=this.cols[a][i];return new V(n,[t,e])}var V=function(){function t(e,n){_(this,t),E(this,"fold",this.reduce),E(this,"length",this.norm),this.data=e,this.shape=n}return S(t,[{key:"rows",get:function(){return this.shape[0]}},{key:"cols",get:function(){return this.shape[1]}},{key:"get",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=C(this.shape,2),r=(n[0],n[1]);return this.data[e+t*r]}},{key:"prod",value:function(e){if(this.cols!==e.rows)throw new H("Incompatible product size. Left ".concat(this.shape,", right ").concat(e.shape));for(var n=this.rows,r=this.cols,i=e.cols,a=new Float64Array(n*i),o=q(0,i),u=0;u<n;u++)for(var s=0;s<i;s++){for(var h=0,c=0;c<r;c++)h+=this.get(u,c)*e.get(c,s);a[o(u,s)]=h}return new t(a,[n,i])}},{key:"dot",value:function(e){if(this.rows!==e.rows)throw new H("Incompatible product size. Left ".concat(this.shape,", right ").concat(e.shape));for(var n=this.rows,r=this.cols,i=e.cols,a=new Float64Array(r*i),o=q(0,i),u=0;u<r;u++)for(var s=0;s<i;s++){for(var h=0,c=0;c<n;c++)h+=this.get(c,u)*e.get(c,s);a[o(u,s)]=h}return new t(a,[r,i])}},{key:"map",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(t){return t},n=U.apply(void 0,k(this.shape));return new t(this.data.map((function(t,r){var i=C(n(r),2),a=i[0],o=i[1];return e(t,a,o)})),this.shape)}},{key:"reduce",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=U.apply(void 0,k(this.shape));return this.data.reduce((function(e,r,i){var a=C(n(i),2),o=a[0],u=a[1];return t(e,r,o,u)}),e)}},{key:"op",value:function(e,n){var r=C(this.shape,2),i=r[0],a=r[1],o=C(e.shape,2),u=o[0],s=o[1];if(i!==u||a!==s)throw new H("Matrix must be of same size");return new t(this.data.map((function(t,r){return n(t,e.data[r])})),this.shape)}},{key:"add",value:function(t){return this.op(t,(function(t,e){return t+e}))}},{key:"sub",value:function(t){return this.op(t,(function(t,e){return t-e}))}},{key:"mul",value:function(t){return this.op(t,(function(t,e){return t*e}))}},{key:"div",value:function(t){return this.op(t,(function(t,e){return t/e}))}},{key:"scale",value:function(t){return this.map((function(e){return e*t}))}},{key:"norm",value:function(){for(var t=0,e=0;e<this.data.length;e++)t+=this.data[e]*this.data[e];return Math.sqrt(t)}},{key:"equals",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e-6;if(!(e instanceof t))return!1;try{return this.sub(e).length()<n}catch(t){return!1}}},{key:"toArray",value:function(){return this.data}}],[{key:"ZERO",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return t.builder().size(e,n).build()}},{key:"random",value:function(e){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=new Float64Array(e*n),i=0;i<r.length;i++)r[i]=Math.random();return new t(r,[e,n])}},{key:"builder",value:function(){return new N}},{key:"rowBuilder",value:function(){return new Z}},{key:"colBuilder",value:function(){return new W}},{key:"vec",value:function(){var t;return(t=new W).addCol.apply(t,arguments).build()}},{key:"cov",value:function(){var t;return(t=new Z).addRow.apply(t,arguments).build()}}]),t}();P=V,E(V,"id",(function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t,n=P.e(t),r=P.colBuilder(),i=0;i<e;i++){var a;r=(a=r).addCol.apply(a,k(n(i).data))}return r.build()})),E(V,"e",(function(t){return function(e){return new P(new Float64Array(t).map((function(t,n){return e===n?1:0})),[t,1])}})),E(V,"dx",(function(t){return function(e){return new P(new Float64Array(t).map((function(t,n){return e===n?1:0})),[1,t])}})),E(V,"vec2",{of:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return P.vec(t,e)},e0:P.vec(1,0),e1:P.vec(0,1),ZERO:P.ZERO(2,1)}),E(V,"vec3",{of:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return P.vec(t,e,n)},e0:P.vec(1,0,0),e1:P.vec(0,1,0),e2:P.vec(0,0,1),ZERO:P.ZERO(3,1)});var H=function(t){j(i,t);var e,n,r=(e=i,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,r=z(e);if(n){var i=z(this).constructor;t=Reflect.construct(r,arguments,i)}else t=r.apply(this,arguments);return D(this,t)});function i(){return _(this,i),r.apply(this,arguments)}return S(i)}(F(Error)),X=function(){function t(e,n){if(_(this,t),E(this,"union",this.add),E(this,"inter",this.sub),this.isEmpty=void 0===e||void 0===n,this.isEmpty)return this;this.min=e.op(n,Math.min),this.max=n.op(e,Math.max),this.center=e.add(n).scale(.5),this.diagonal=n.sub(e)}return S(t,[{key:"add",value:function(e){if(this===t.EMPTY)return e;var n=this.min,r=this.max;return new t(n.op(e.min,Math.min),r.op(e.max,Math.max))}},{key:"sub",value:function(e){if(this===t.EMPTY)return t.EMPTY;var n=this.min,r=this.max,i=n.op(e.min,Math.max),a=r.op(e.max,Math.min);return a.sub(i).data.every((function(t){return t>=0}))?new t(i,a):t.EMPTY}},{key:"move",value:function(e){return new t(this.min.add(e),this.max.add(e))}},{key:"collidesWith",value:function(e){for(var n=this,r=[{type:t,action:function(){return!n.sub(e).isEmpty}},{type:V,action:function(){return!n.sub(new t(e,e)).isEmpty}}],i=0;i<r.length;i++)if(e instanceof r[i].type)return r[i].action()}},{key:"equals",value:function(e){return e instanceof t&&(this==t.EMPTY||this.min.equals(e.min)&&this.max.equals(e.max))}}],[{key:"ofPoint",value:function(){var e=V.vec.apply(V,arguments);return new t(e,e)}}]),t}();E(X,"EMPTY",new X);var K=V.vec2,$=function(){function t(e){_(this,t),E(this,"getDom",this.getCanvas),this.canvas=e,this.ctx=e.getContext("2d",{willReadFrequently:!0}),this.image=this.ctx.getImageData(0,0,e.width,e.height),this.data=this.image.data}return S(t,[{key:"getCanvas",value:function(){return this.canvas}},{key:"width",get:function(){return this.canvas.width}},{key:"height",get:function(){return this.canvas.height}},{key:"fill",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:O.ofRGBARaw(255,255,255);return this.ctx.fillStyle="rgba(".concat(t.red,", ").concat(t.green,", ").concat(t.blue,", ").concat(t.alpha/255,")"),console.log(this.ctx.fillStyle),this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.image=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),this.data=this.image.data,this}},{key:"map",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){},e=this.data.length,n=this.canvas.width,r=0;r<e;r+=4){var i=Math.floor(r/(4*n)),a=Math.floor(r/4)%n,o=t(O.ofRGBARaw(this.data[r],this.data[r+1],this.data[r+2],this.data[r+3]),i,a);this.data[r]=o.red,this.data[r+1]=o.green,this.data[r+2]=o.blue,this.data[r+3]=o.alpha}return this}},{key:"getPxl",value:function(t,e){var n=this.canvas,r=n.width,i=n.height;if(!(t<0||t>=i||e<0||e>=r)){var a=4*(t*r+e);return O.ofRGBARaw(this.data[a],this.data[a+1],this.data[a+2],this.data[a+3])}}},{key:"setPxl",value:function(t,e,n){var r=this.canvas,i=r.width,a=r.height;if(t<0||t>=a||e<0||e>=i)return this;var o=4*(t*i+e);return this.data[o]=n.red,this.data[o+1]=n.green,this.data[o+2]=n.blue,this.data[o+3]=n.alpha,this}},{key:"drawLine",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(t,e){return O.ofRGBA(0,0,0)},r=this.canvas,i=r.width,a=(r._,this._clipLine(t,e).map((function(t){return t.toArray()})));if(0!==a.length){for(var o=C(a,2),u=o[0],s=o[1],h=[s[0]-u[0],s[1]-u[1]],c=Math.abs(h[0])+Math.abs(h[1]),l=0;l<c;l++){var f=l/c,v=C([u[0]+h[0]*f,u[1]+h[1]*f].map(Math.floor),2),d=v[0],p=v[1],g=4*(d*i+p),y=n(d,p);this.data[g]=y.red,this.data[g+1]=y.green,this.data[g+2]=y.blue,this.data[g+3]=y.alpha}return this}}},{key:"drawTriangle",value:function(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(t,e){return O.ofRGBA(0,0,0)};return this._drawConvexPolygon([t,e,n],r)}},{key:"paint",value:function(){this.ctx.putImageData(this.image,0,0)}},{key:"_drawConvexPolygon",value:function(t,e){var n=this.canvas,r=n.width,i=n.height,a=new X(K.ZERO,K.of(i,r)),o=X.EMPTY;t.forEach((function(t){o=o.add(X.ofPoint.apply(X,k(t)))}));for(var u=a.inter(o),s=C(u.min.toArray(),2),h=s[0],c=s[1],l=C(u.max.toArray(),2),f=l[0],v=l[1],d=h;d<f;d++)for(var p=c;p<v;p++)if(this._isInsideConvex([d,p],t)){var g=e(d,p),y=4*(d*r+p);this.data[y]=g.red,this.data[y+1]=g.green,this.data[y+2]=g.blue,this.data[y+3]=g.alpha}return this}},{key:"_isInsideConvex",value:function(t,e){for(var n=e.length,r=[],i=[],a=0;a<n;a++){var o=e[(a+1)%n],u=e[a];r[a]=[o[0]-u[0],o[1]-u[1]];var s=r[a],h=[-s[1],s[0]],c=[t[0]-u[0],t[1]-u[1]];i[a]=c[0]*h[0]+c[1]*h[1]}for(var l=r[0][0]*r[1][1]-r[0][1]*r[1][0]>=0?1:-1,f=0;f<n;f++)if(i[f]*l<0)return!1;return!0}},{key:"_clipLine",value:function(t,e){for(var n=this.canvas,r=n.width,i=n.height,a=new X(K.ZERO,K.of(i,r)),o=[t,e].map((function(t){return K.of.apply(K,k(t))})),u=[],s=[],h=0;h<o.length;h++){var c=o[h];a.collidesWith(c)?u.push(c):s.push(c)}if(u.length>=2)return u;if(1===u.length){var l=u[0],f=s[0];return[l].concat(k(this._getLineCanvasIntersection(l,f)))}return this._getLineCanvasIntersection.apply(this,s)}},{key:"_getLineCanvasIntersection",value:function(t,e){var n=this,r=this.canvas,i=r.width,a=r.height,o=e.sub(t),u=[[K.ZERO,K.of(a,0)],[K.of(a,0),K.of(0,i)],[K.of(a,i),K.of(-a,0)],[K.of(0,i),K.of(0,-i)]],s=[];u.forEach((function(e){var r=C(e,2),i=r[0],a=r[1];if(0===a.get(0)){var u=n._solveLowTriMatrix(o,-a.get(1),i.sub(t));void 0!==u&&s.push(u)}else{var h=n._solveUpTriMatrix(o,-a.get(0),i.sub(t));void 0!==h&&s.push(h)}}));var h=[];return s.forEach((function(t){var e=[t.get(0),t.get(1)],n=e[0],r=e[1];0<=n&&n<=1&&0<=r&&r<=1&&h.push(t)})),0===h.length?[]:h.map((function(e){var n=e.get(0);return t.add(o.scale(n))}))}},{key:"_solveLowTriMatrix",value:function(t,e,n){var r=t.get(0),i=t.get(1),a=e*r;if(0!==a&&0!==r){var o=n.get(0),u=n.get(1);return K.of(o/r,(u*r-i*o)/a)}}},{key:"_solveUpTriMatrix",value:function(t,e,n){var r=t.get(0),i=t.get(1),a=e*i;if(0!==a&&0!==i){var o=n.get(0),u=n.get(1);return K.of(u/i,(o*i-r*u)/a)}}}],[{key:"builder",value:function(){return new J}}]),t}(),J=function(){function t(){_(this,t),E(this,"_canvas",document.createElement("canvas")),E(this,"_width",500),E(this,"_height",500)}return S(t,[{key:"width",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._width;return this._width=t,this}},{key:"height",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._height;return this._height=t,this}},{key:"build",value:function(){return this._canvas.setAttribute("width",this._width),this._canvas.setAttribute("height",this._height),new $(this._canvas)}}]),t}(),tt=function(t){var e=performance.now();return t(),performance.now()-e},et=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:nt;return function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},r=t(),i=tt((function(){return n(r)})),a=document.createElement("div"),o=document.createElement("h3");o.innerText=e,a.appendChild(o),a.appendChild(r.getDom());var u=document.createElement("h4");u.innerText="Test took ".concat(i,"ms"),a.appendChild(u),document.body.appendChild(a)}},nt=function(){return Canvas.builder().width(500).height(500).build()},rt=function(){function t(e,n,r){_(this,t),this.state=e,this.next=n,this.while=r,this.requestAnimeId=null}return S(t,[{key:"play",value:function(){var t=this;return this.requestAnimeId=requestAnimationFrame((function(){if(!t.while(t.state))return t.stop();t.state=t.next(t.state),t.play()})),this}},{key:"run",value:function(){for(;this.while(this.state);)this.state=this.next(this.state);return this}},{key:"stop",value:function(){return cancelAnimationFrame(this.requestAnimeId),this}}],[{key:"builder",value:function(){return new it}}]),t}(),it=function(){function t(){_(this,t),this._state=null,this._next=null,this._end=null}return S(t,[{key:"initialState",value:function(t){return this._state=t,this}},{key:"nextState",value:function(t){return this._next=t,this}},{key:"while",value:function(t){return this._end=t,this}},{key:"build",value:function(){if([this._state,this._next,this._end].some((function(t){return null==t})))throw new Error("Animator properties are missing");return new rt(this._state,this._next,this._end)}}]),t}();function at(){return at="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,n){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=z(t)););return t}(t,e);if(r){var i=Object.getOwnPropertyDescriptor(r,e);return i.get?i.get.call(arguments.length<3?t:n):i.value}},at.apply(this,arguments)}function ot(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=z(t);if(e){var i=z(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return D(this,n)}}var ut=V.vec2,st=function(t){j(n,t);var e=ot(n);function n(t,r){var i;return _(this,n),(i=e.call(this,t)).camera=r,i}return S(n,[{key:"setCamera",value:function(t){this.camera=t}},{key:"map",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};return at(z(n.prototype),"map",this).call(this,(function(n,r,i){var a=C(t.forwardCoord(r,i),2),o=a[0],u=a[1];return e(n,o,u)}))}},{key:"getPxl",value:function(t,e){var r=C(this.inverseCoord(t,e),2),i=r[0],a=r[1];return at(z(n.prototype),"getPxl",this).call(this,i,a)}},{key:"setPxl",value:function(t,e,r){var i=C(this.inverseCoord(t,e),2),a=i[0],o=i[1];return at(z(n.prototype),"setPxl",this).call(this,a,o,r)}},{key:"drawLine",value:function(t,e,r){var i=this.inverseCoord.apply(this,k(t)),a=this.inverseCoord.apply(this,k(e));return at(z(n.prototype),"drawLine",this).call(this,i,a,r)}},{key:"drawTriangle",value:function(t,e,r,i){var a=this.inverseCoord.apply(this,k(t)),o=this.inverseCoord.apply(this,k(e)),u=this.inverseCoord.apply(this,k(r));return at(z(n.prototype),"drawTriangle",this).call(this,a,o,u,i)}},{key:"inverseCoord",value:function(t,e){var n=this.camera,r=n.min,i=n.max,a=this.canvas,o=a.width,u=a.height,s=C(r.data,2),h=s[0],c=s[1],l=C(i.data,2),f=l[0],v=l[1];return[-(e-v)*(u-1)/(v-c),(t-h)*(o-1)/(f-h)].map(Math.floor)}},{key:"forwardCoord",value:function(t,e){var n=this.camera,r=n.min,i=n.max,a=this.canvas,o=a.width,u=a.height,s=C(r.data,2),h=s[0],c=s[1],l=C(i.data,2),f=l[0],v=l[1];return[h+(f-h)*e/(o-1),v+(c-v)*t/(u-1)]}}],[{key:"builder",value:function(){return new ht}}]),n}($),ht=function(t){j(n,t);var e=ot(n);function n(){var t;_(this,n);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return E(L(t=e.call.apply(e,[this].concat(i))),"_camera",new X(ut.of(-1,-1),ut.of(1,1))),t}return S(n,[{key:"camera",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._camera;return this._camera=t,this}},{key:"build",value:function(){var t=at(z(n.prototype),"build",this).call(this);return new st(t.canvas,this._camera)}}]),n}(J);return e})()));
//# sourceMappingURL=index.js.map